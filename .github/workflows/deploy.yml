name: Build and Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_OWNER: taofeek26
  BACKEND_IMAGE: ghcr.io/taofeek26/bet-hope-backend
  FRONTEND_IMAGE: ghcr.io/taofeek26/bet-hope-frontend

jobs:
  build-and-push:
    name: Build and Push Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: |
            ${{ env.BACKEND_IMAGE }}:latest
            ${{ env.BACKEND_IMAGE }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: |
            ${{ env.FRONTEND_IMAGE }}:latest
            ${{ env.FRONTEND_IMAGE }}:${{ github.sha }}
          build-args: |
            NEXT_PUBLIC_API_URL=${{ secrets.BACKEND_URL }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Deploy to Oracle Cloud
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 145.241.188.142
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          command_timeout: 60m
          script: |
            cd /opt/bet_hope

            echo "=========================================="
            echo "PHASE 1: Preparation"
            echo "=========================================="

            echo "Stashing local changes..."
            git stash

            echo "Pulling latest code..."
            git pull origin main

            echo "Logging in to GitHub Container Registry..."
            echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            echo "=========================================="
            echo "PHASE 2: Stop all services to free memory"
            echo "=========================================="

            echo "Checking current memory..."
            free -h

            echo "Stopping all application containers..."
            docker compose -f docker-compose.prod.yml stop celery celery-beat backend frontend nginx || true

            echo "Memory after stopping services..."
            free -h

            echo "Cleaning up unused Docker resources..."
            docker system prune -f || true

            echo "=========================================="
            echo "PHASE 3: Pull new images"
            echo "=========================================="

            echo "Pulling backend image..."
            docker pull ghcr.io/taofeek26/bet-hope-backend:latest

            echo "Pulling frontend image..."
            docker pull ghcr.io/taofeek26/bet-hope-frontend:latest

            echo "=========================================="
            echo "PHASE 4: Start all services"
            echo "=========================================="

            echo "Starting all containers with new images..."
            docker compose -f docker-compose.prod.yml up -d

            echo "Waiting for services to initialize..."
            sleep 15

            echo "=========================================="
            echo "PHASE 5: Post-deployment tasks"
            echo "=========================================="

            echo "Running database migrations..."
            docker compose -f docker-compose.prod.yml exec -T backend python manage.py migrate --noinput

            echo "Collecting static files..."
            docker compose -f docker-compose.prod.yml exec -T backend python manage.py collectstatic --noinput

            echo "=========================================="
            echo "PHASE 6: Verification"
            echo "=========================================="

            echo "Checking service status..."
            docker compose -f docker-compose.prod.yml ps

            echo "Final memory status..."
            free -h

            echo "Cleaning up old images..."
            docker image prune -f || true

            echo "=========================================="
            echo "DEPLOYMENT COMPLETED SUCCESSFULLY!"
            echo "=========================================="

      - name: Notify on success
        if: success()
        run: echo "Deployment to production completed successfully!"

      - name: Notify on failure
        if: failure()
        run: echo "Deployment failed! Check the logs above for details."
